(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{451:function(t,s,a){t.exports=a.p+"assets/img/elkdockercomposestructer.c5bcb7fd.jpg"},486:function(t,s,a){"use strict";a.r(s);var e=a(65),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"elastic-stack-環境建置-docker-compose"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#elastic-stack-環境建置-docker-compose"}},[t._v("#")]),t._v(" Elastic stack 環境建置(docker compose)")]),t._v(" "),e("p",[t._v("此篇用 docker compose 搭建 Elastic stack ，達到一鍵啟動 Elastic stack 單節點環境的效果，需要達到的目標如下")]),t._v(" "),e("ul",[e("li",[t._v("編寫專用的 docker compose yml 啟動服務")]),t._v(" "),e("li",[t._v("將 Elastic stack 各項服務資料持久化到硬碟上")]),t._v(" "),e("li",[t._v("將 Elastic stack 各項 Config 暴露到實體路徑")]),t._v(" "),e("li",[t._v("詳細設定各種參數")]),t._v(" "),e("li",[t._v("因為各種莫名奇妙的原因版號變成 7.17.1 了，"),e("s",[t._v("懶得改回 7.17.4...")])])]),t._v(" "),e("p",[t._v("Reference")]),t._v(" "),e("ul",[e("li",[t._v("架構參考至原文傳送門 "),e("a",{attrs:{href:"https://github.com/deviantony/docker-elk",target:"_blank",rel:"noopener noreferrer"}},[t._v("The Elastic stack (ELK) powered by Docker and Compose."),e("OutboundLink")],1)]),t._v(" "),e("li",[t._v("Filebeat 官方文件 "),e("a",{attrs:{href:"https://www.elastic.co/guide/en/beats/filebeat/current/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Filebeat Reference"),e("OutboundLink")],1)]),t._v(" "),e("li",[t._v("Logstash 官方文件 "),e("a",{attrs:{href:"https://www.elastic.co/guide/en/logstash/current/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Logstash Reference"),e("OutboundLink")],1)])]),t._v(" "),e("h2",{attrs:{id:"服務架構"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#服務架構"}},[t._v("#")]),t._v(" 服務架構")]),t._v(" "),e("p",[e("img",{attrs:{src:a(451),alt:"elkdockercomposestructer"}})]),t._v(" "),e("h2",{attrs:{id:"docker-compose-檔案結構"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-檔案結構"}},[t._v("#")]),t._v(" Docker Compose 檔案結構")]),t._v(" "),e("p",[t._v("整個 ELK Stack 啟動文件如下，每個服務皆用一個資料夾維護其需要持久化的檔案分別為 elasticsearch;filebeat;kibana;logstash;nginx :")]),t._v(" "),e("div",{staticClass:"language-Text extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("|\n├── elasticsearch                       # elasticsearch\n│   ├── config                          # elasticsearch 設定文件\n│   │   └── elasticsearch.yml\n│   ├── data                            # 主要持久化資料的地方\n│   └── plugins                         # 預留要掛插件的資料夾\n|\n├── filebeat                            # filebeat\n│   ├── config                          # filebeat 設定文件\n│   │   └── filebeat.yml\n|   └── modules                         # filebeat modules 設定文件\n|       └── nginx.yml\n|\n├── kibana                              # kibana \n│   └── config                          # kibana 設定文件\n│       └── kibana.yml\n|\n├── logstash                            # logstash\n│   ├── config                          # logstash 設定文件\n│   │   └── logstash.yml\n│   └── pipeline                        # logstash pipeline 設定文件\n│       └── logstash.conf\n|\n├── nginx                               # NGINX\n│   ├── conf.d                          # 預計放 Config 的地方\n│   ├── log                             # nginx log > filebeat 主要會指向這邊並擷取資料\n│   |   ├── access.log\n│   |   └── error.log\n|   └── html                            # 放一些預設的靜態頁面以方便測試\n|\n└── docker-compose.yml                  # docker-compose up -d 在docker中執行上述所有服務\n")])])]),e("h2",{attrs:{id:"docker-compose-啟動文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-啟動文件"}},[t._v("#")]),t._v(" Docker Compose 啟動文件")]),t._v(" "),e("p",[t._v("docker compose 啟動文件如下:")]),t._v(" "),e("ul",[e("li",[t._v("elasticsearch 單節點啟動 映射 9200 port; 9300 給叢集用的暫時沒用到")]),t._v(" "),e("li",[t._v("kibana 映射 5601 port; 指定 "),e("code",[t._v("ELASTICSEARCH_HOSTS=http://myelasticsearch01:9200")]),t._v(" 提供資料來源")]),t._v(" "),e("li",[t._v("logstash 映射 5044 port 供 beat 傳入資料; 9600 port 為外部API用")]),t._v(" "),e("li",[t._v("nginx 映射 7414 port; 將 log 持久化至磁碟")]),t._v(" "),e("li",[t._v("filebeat 主要提供服務不映射 port 號; "),e("code",[t._v("filebeat -e -strict.perms=false")]),t._v(" 以不檢查檔案的方式啟動; 主要取資料的地方會與 nginx 綁定在同一個空間")]),t._v(" "),e("li",[t._v("以下服務全部會啟動再同一個 docker network 中")])]),t._v(" "),e("div",{staticClass:"language-YAML extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.8'")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("elasticsearch01")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker.elastic.co/elasticsearch/elasticsearch"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.17.1\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myelasticsearch01\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"discovery.type=single-node"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" on"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("failure\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 9200"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9200")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 9300"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9300")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" bind\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ./elasticsearch/config/elasticsearch.yml\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /usr/share/elasticsearch/config/elasticsearch.yml\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./elasticsearch/data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/usr/share/elasticsearch/data\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./elasticsearch/plugins"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/usr/share/elasticsearch/plugins\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" elknetwrok\n\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kibana")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker.elastic.co/kibana/kibana"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.17.1\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mykibana\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ELASTICSEARCH_HOSTS=http://myelasticsearch01:9200"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 5601"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5601")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" bind\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ./kibana/config/kibana.yml\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /usr/share/kibana/config/kibana.yml\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" elknetwrok\n\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("logstash")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker.elastic.co/logstash/logstash"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.17.1\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mylogstash\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 5044"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5044")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 9600"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9600")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" bind\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ./logstash/config/logstash.yml\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /usr/share/logstash/config/logstash.yml\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" bind\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ./logstash/pipeline/logstash.conf\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /usr/share/logstash/pipeline/logstash.conf\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" elknetwrok\n\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nginx")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mynginx\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 7414"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./nginx/log/nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/log/nginx\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./nginx/html"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/usr/share/nginx/html\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" elknetwrok\n\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("filebeat")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker.elastic.co/beats/filebeat"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("7.17.1\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("user")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myfilebeat\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" filebeat "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("e "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("strict.perms=false\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" bind\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("source")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ./filebeat/config/filebeat.yml\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /usr/share/filebeat/filebeat.yml\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./nginx/log/nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/log/nginx\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" elknetwrok\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("depends_on")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" elasticsearch\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" logstash\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" kibana\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" nginx\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("elknetwrok")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" elknetwrok\n")])])]),e("p",[t._v("以 "),e("code",[t._v("docker-compose up -d")]),t._v(" 執行YAML檔;執行成功顯示如下:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("C:"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Users"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("mobet"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("docker "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v("\nCONTAINER ID   IMAGE                                                  COMMAND                  CREATED       STATUS             PORTS                                            NAMES\n5df7807c57e0   docker.elastic.co/beats/filebeat:7.17.1                "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/bin/tini -- /u…"')]),t._v("   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" hours ago   Up "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" hours                                                          myfilebeat\ndebccbfeb4fe   docker.elastic.co/logstash/logstash:7.17.1             "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/local/bin/dock…"')]),t._v("   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" hours ago   Up About an hour   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:5044-"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5044")]),t._v("/tcp, "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:9600-"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9600")]),t._v("/tcp   mylogstash\n646ef2f0ce45   docker.elastic.co/elasticsearch/elasticsearch:7.17.1   "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/bin/tini -- /usr/l…"')]),t._v("   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" hours ago   Up "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" hours         "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:9200-"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9200")]),t._v("/tcp, "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:9300-"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9300")]),t._v("/tcp   myelasticsearch01\n0d6d08fd3761   nginx:latest                                           "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/docker-entrypoint.…"')]),t._v("   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" hours ago   Up "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" hours         "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:7414-"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("/tcp                             mynginx\n4c101a1f203f   docker.elastic.co/kibana/kibana:7.17.1                 "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/bin/tini -- /usr/l…"')]),t._v("   "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" hours ago   Up "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" hours         "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:5601-"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5601")]),t._v("/tcp                           mykibana\n")])])]),e("h2",{attrs:{id:"重要的-config"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#重要的-config"}},[t._v("#")]),t._v(" 重要的 Config")]),t._v(" "),e("p",[t._v("ELK Stack 作為開箱即用的服務有大量的 Config 可以配置，簡單紀錄一下兩個設定比較神秘的 config :")]),t._v(" "),e("h3",{attrs:{id:"filebeat-yml"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#filebeat-yml"}},[t._v("#")]),t._v(" filebeat.yml")]),t._v(" "),e("p",[t._v("主要描述 filebeat 該如何採集資料與採集甚麼資料")]),t._v(" "),e("ul",[e("li",[t._v("filebeat.modules : filebeat中有許多內置的模組藉由編寫設定便可以輕鬆採集資料這裡使用 NGINX module")]),t._v(" "),e("li",[t._v("filebeat.modules.access.var.paths 中的路徑便採集對象所在的資料夾")]),t._v(" "),e("li",[t._v("output : 指定 filebeat 採集後的資料要發送到哪邊")]),t._v(" "),e("li",[t._v("官方模組列表 "),e("a",{attrs:{href:"https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.html"),e("OutboundLink")],1)]),t._v(" "),e("li",[t._v('filebeat 是以 GO 語言開發的服務;本身理解其特性較為面向 "client" 端')])]),t._v(" "),e("div",{staticClass:"language-YAML extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ============================== Filebeat modules ==============================")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("filebeat.config")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("modules")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("path.config"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/modules.d/"),e("span",{pre:!0,attrs:{class:"token important"}},[t._v("*.yml")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("reload.enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("filebeat.modules")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("module")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("access")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("var.paths")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/var/log/nginx'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("var.paths")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/log/nginx/error.log"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ======================= Elasticsearch template setting =======================")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("setup.template.settings")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("index.number_of_shards")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#index.codec: best_compression")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#_source.enabled: false")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ================================== Outputs ===================================")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Configure what output to use when sending the data collected by the beat.")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# output.elasticsearch:")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#   hosts: ["http://myelasticsearch01:9200/"]')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("output.logstash")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mylogstash:5044"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n")])])]),e("h3",{attrs:{id:"logstash-conf"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#logstash-conf"}},[t._v("#")]),t._v(" logstash.conf")]),t._v(" "),e("p",[t._v("主要描述想透過 logstash 輸入、過濾、輸出甚麼資料:")]),t._v(" "),e("ul",[e("li",[t._v("分為三個區塊分別為 input;filter;output")]),t._v(" "),e("li",[t._v("input : 設定資料來源;這裡為接收 beats 傳送過來的資料")]),t._v(" "),e("li",[t._v("filter : 針對來源資料做清洗與解析")]),t._v(" "),e("li",[t._v("output : 將資料轉送至何處持久化;這裡為轉送至 elasticsearch 並以 mybeat-%{+YYYY.MM.dd} 作為 index 儲存")]),t._v(" "),e("li",[t._v("filter 內容來源至官方 NGINX 範例加以改寫; "),e("a",{attrs:{href:"https://www.elastic.co/guide/en/logstash/7.4/logstash-config-for-filebeat-modules.html#parsing-nginx",target:"_blank",rel:"noopener noreferrer"}},[t._v("範例來源官方連結"),e("OutboundLink")],1)]),t._v(" "),e("li",[t._v('logstash 是以 JAVA 語言開發的服務;本身理解其特性較為面向 "server" 端')])]),t._v(" "),e("div",{staticClass:"language-TEXT extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('input {\n  beats {\n    port => 5044\n  }\n}\nfilter {\n  if [event][module] == "nginx" {\n    if [fileset][name] == "ingress_controller" {\n      grok {\n        match => { "message" => ["%{IPORHOST:[nginx][access][remote_ip]} - %{DATA:[nginx][access][user_name]|-} \\[%{HTTPDATE:[nginx][access][time]}\\] \\"%{WORD:[nginx][access][method]} %{DATA:[nginx][access][url]} HTTP/%{NUMBER:[nginx][access][http_version]}\\" %{NUMBER:[nginx][access][response_code]} %{NUMBER:[nginx][access][body_sent][bytes]} \\"%{DATA:[nginx][access][referrer]}\\" \\"%{DATA:[nginx][access][agent]}\\""] }\n        remove_field => "message"\n      }\n      mutate {\n        add_field => { "read_timestamp" => "%{@timestamp}" }\n      }\n      date {\n        match => [ "[nginx][access][time]", "dd/MMM/YYYY:H:m:s Z" ]\n        remove_field => "[nginx][access][time]"\n      }\n      useragent {\n        source => "[nginx][access][agent]"\n        target => "[nginx][access][user_agent]"\n        remove_field => "[nginx][access][agent]"\n      }\n      geoip {\n        source => "[nginx][access][remote_ip]"\n        target => "[nginx][access][geoip]"\n      }\n    }    \n  }\n}\noutput {\n  elasticsearch  {\n    hosts => "myelasticsearch01:9200"\n    index => "mybeat-%{+YYYY.MM.dd}"\n  }\n}\n')])])]),e("h2",{attrs:{id:"基本使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基本使用"}},[t._v("#")]),t._v(" 基本使用")]),t._v(" "),e("h2",{attrs:{id:"排雷大隊"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#排雷大隊"}},[t._v("#")]),t._v(" 排雷大隊")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("記憶體很重要")])]),t._v(" "),e("li",[e("p",[t._v("docker 中請用 "),e("code",[t._v("command: filebeat -e -strict.perms=false")]),t._v(" 啟動filebeat，不要用 entrypoint ; entrypoint 會再幫你啟動一次 beat 一次會丟兩筆資料...一時不察偵錯很久。command 與 entrypoint 的差異一個覆蓋指令;一個是追加指令如果有幸把 docker 的筆記整理過來再附上比較連結")])]),t._v(" "),e("li",[e("p",[t._v("如果 Logstash 出現 "),e("code",[t._v("Could not index event to Elasticsearch")]),t._v(" 這個錯誤")]),t._v(" "),e("div",{staticClass:"language-TEXT extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[2022-06-27T12:28:40,210][ERROR][logstash.outputs.elasticsearch][main][63c7cebabda6b571b9b01c302e26faff25c0e5dc84e5e82df9e9a79abd46f857] Could not index event to Elasticsearch. {:status=>400, :action=>["index", {:_id=>nil, :_index=>"%{[Mybeat]}-2022.06.27", :routing=>nil}, {"fileset"=>{"name"=>"ingress_controller"}, "input"=>{"type"=>"log"}, "event"=>{"timezone"=>"+00:00", "dataset"=>"nginx.ingress_controller", "module"=>"nginx"}, "tags"=>["beats_input_codec_plain_applied"], "host"=>{"hostname"=>"876652f136f8", "ip"=>["172.21.0.5"], "mac"=>["02:42:ac:15:00:05"], "os"=>{"kernel"=>"5.10.16.3-microsoft-standard-WSL2", "platform"=>"ubuntu", "family"=>"debian", "codename"=>"focal", "version"=>"20.04.3 LTS (Focal Fossa)", "name"=>"Ubuntu", "type"=>"linux"}, "name"=>"876652f136f8", "containerized"=>true, "architecture"=>"x86_64"}, "agent"=>{"ephemeral_id"=>"777ba821-b649-46e2-9ee1-a409193c5545", "hostname"=>"876652f136f8", "id"=>"7f7c2a40-d0d9-461e-a9a1-96dced9967fd", "version"=>"7.17.1", "name"=>"876652f136f8", "type"=>"filebeat"}, "ecs"=>{"version"=>"1.12.0"}, "service"=>{"type"=>"nginx"}, "@timestamp"=>2022-06-27T12:28:37.268Z, "message"=>"172.21.0.1 - - [27/Jun/2022:12:28:33 +0000] \\"GET /helloworld01.html HTTP/1.1\\" 200 21 \\"-\\" \\"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.0.0 Safari/537.36\\" \\"-\\"", "@version"=>"1", "log"=>{"offset"=>1204, "file"=>{"path"=>"/var/log/nginx/access.log"}}}], :response=>{"index"=>{"_index"=>"%{[Mybeat]}-2022.06.27", "_type"=>"_doc", "_id"=>nil, "status"=>400, "error"=>{"type"=>"invalid_index_name_exception", "reason"=>"Invalid index name [%{[Mybeat]}-2022.06.27], must be lowercase", "index_uuid"=>"_na_", "index"=>"%{[Mybeat]}-2022.06.27"}}}}\n')])])]),e("p",[t._v("看一下 Reason 通常會提示你 "),e("code",[t._v('Invalid index name [%{[Mybeat]}-2022.06.27], must be lowercase"')]),t._v(" 這邊就是說 Index 不能是大寫...")])]),t._v(" "),e("li",[e("p",[t._v('出現 config file ("filebeat.yml") can only be writable')]),t._v(" "),e("div",{staticClass:"language-TEXT extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('config file ("filebeat.yml") can only be writable by the owner but the permissions are "-rwxrwxrwx" (to fix the permissions use: \'chmod go-w /usr/share/filebeat/filebeat.yml\')\n')])])]),e("p",[t._v("先讓 "),e("code",[t._v("filebeat -e -strict.perms=false")])])]),t._v(" "),e("li",[e("p",[e("code",[t._v("filebeat -h")]),t._v(" 這個指令很好用...")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);